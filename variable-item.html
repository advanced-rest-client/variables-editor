<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-input/paper-input-container.html">
<link rel="import" href="../paper-input/paper-input-error.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="variable-editor-dialog.html">
<!--
# `variable-item`

It is a variable list item to be displayed in the `<variable-editor>`.

### Styling
`<variable-item>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--variable-item` | Mixin applied to the element | `{}`
`--variable-item-name-input` | Mixin applied to the `paper-input` for variable name | `{}`
`--variable-item-value-input` | Mixin applied to the `paper-input` for variable value | `{}`
`--variable-item-checkbox` | Mixin applied to the state checkbox | `{}`
`--inline-fom-action-icon-color` | Theme variable, color of the delete variable icon | `rgba(0, 0, 0, 0.74)`
`--inline-fom-action-icon-color-hover` | Theme variable, color of the delete variable icon when hovering | `--accent-color` or `rgba(0, 0, 0, 0.74)`

@group UI Elements
@element variable-item
@demo demo/index.html
-->
<dom-module id="variable-item">
  <template>
    <style>
    :host {
      display: block;
      position: relative;
      @apply(--variable-item);
    }

    #container {
      @apply(--layout-horizontal);
      @apply(--layout-flex);
      @apply(--layout-end);
    }

    .variable-name {
      margin-right: 12px;
      @apply(--variable-item-name-input);
    }

    .variable-value {
      @apply(--layout-flex);
      @apply(--variable-item-value-input);
    }

    paper-checkbox {
      margin-bottom: 12px;
      @apply(--variable-item-checkbox);
    }

    .action-icon {
      color: var(--inline-fom-action-icon-color, rgba(0, 0, 0, 0.74));
      transition: color 0.2s linear;
    }

    .action-icon:hover {
      color: var(--inline-fom-action-icon-color-hover, var(--accent-color, rgba(0, 0, 0, 0.74)));
    }
    </style>
    <div id="container">
      <paper-checkbox checked="{{item.enabled}}" title="Enabled" on-change="_somethingChanged"></paper-checkbox>
      <paper-input-container class="variable-name" no-label-float inline auto-validate>
        <input is="iron-input" type="text" value="{{item.variable::input}}" placeholder="Variable name" required allowed-pattern="[a-zA-Z0-9_-]" prevent-invalid-input on-change="_somethingChanged"/>
        <paper-input-error>Variable name is not valid</paper-input-error>
      </paper-input-container>
      <paper-input-container class="variable-value" no-label-float inline auto-validate id="valueContainer">
        <input is="iron-input" type="text" value="{{item.value::input}}" placeholder="Variable value" required on-change="_somethingChanged"/>
        <paper-input-error>Variable value should not be empty</paper-input-error>
      </paper-input-container>
      <span>
        <paper-icon-button class="action-icon" icon="arc:edit" on-tap="_openVariableEditor"></paper-icon-button>
        <paper-tooltip animation-delay="200" fit-to-visible-bounds>Edit variable in the editor</paper-tooltip>
      </span>
      <span>
        <paper-icon-button class="action-icon" icon="arc:close" on-tap="_removeVariable"></paper-icon-button>
        <paper-tooltip animation-delay="200" fit-to-visible-bounds>Remove variable</paper-tooltip>
      </span>
    </div>
    <paper-toast text="Variables manager not found. Please, report an issue." id="noModel"></paper-toast>
    <paper-toast text="" id="errorToast" duration="5000"></paper-toast>
  </template>
  <script>
  (function() {
    Polymer({
      is: 'variable-item',
      /**
       * Fired when the variable has been removed from the data-store.
       * Event should be handled by the `variables-editor` to remove it from the UI.
       *
       * @event variable-deleted
       * @param {String} id Variable ID
       */
      /**
       * Fired when not-saved variable has ben requested to be removed.
       *
       * @event empty-variable-remove
       */
      properties: {
        /**
         * A variable database object.
         * Initially it will contain an _id and _rev object and data will be get from the database.
         * Special case is when creating new variable. It will then contain an initial data but no ID.
         */
        item: Object,
        // A list of names that are restricted
        reservedNames: {
          type: Array,
          value: function() {
            return ['now', 'random'];
          }
        },
        /**
         * True if during the save another change occured and the item
         * schould be saved again.
         */
        _isDirty: Boolean,
        /** True if the item is currently being updated. */
        _updatingModel: Boolean
      },

      observers: ['_itemChanged(item._rev)'],

      listeners: {
        'variable-editor-closed': '_onVariableEditorClosed'
      },

      _itemChanged: function() {
        this._updatingModel = false;
        if (this._isDirty) {
          this._somethingChanged();
        }
      },

      // Called when any `item` propery change because of the form input.
      _somethingChanged: function() {
        if (this._updatingModel) {
          this._isDirty = true;
          return;
        }

        var item = this.item;
        if (item.variable && item.value) {
          var context = this;
          if (!this.item._id) {
            this.set('item.enabled', true);
          }
          this.debounce('variable-item-update', function() {
            context._updateItem();
          }, 350);
        }
      },
      // Requests `item` save in the database.
      _updateItem: function() {
        this._updatingModel = true;

        var event = this.fire('variable-updated', {
          value: Object.assign({}, this.item)
        }, {
          cancelable: true
        });

        if (event.detail.error || !event.defaultPrevented) {
          this.$.noModel.opened = true;
          return;
        }
      },
      // Handler for the remove button click.
      _removeVariable: function() {
        var id = this.item._id;
        if (!id) {
          return this.fire('empty-variable-remove', null, {
            bubbles: false
          });
        }
        this.fire('variable-deleted', {
          value: this.item._id
        }, {
          cancelable: true
        });
        this.fire('send-analytics', {
          type: 'event',
          category: 'Variables editor',
          action: 'Delete variable'
        });
      },

      _openVariableEditor: function() {
        var dialog = this.$$('variable-editor-dialog');
        if (!dialog) {
          dialog = document.createElement('variable-editor-dialog');
          Polymer.dom(this.root).appendChild(dialog);
        }
        dialog.value = this.item.value;
        dialog.opened = true;
      },

      _onVariableEditorClosed: function(e) {
        this.set('item.value', e.detail.value);
        this._somethingChanged();
      }
    });

  })();
  </script>
</dom-module>
