<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="variable-item.html">
<!--
# `<variables-editor>`
A variables editor element is an UI element to display existing variables and forms to edit them.

This is only an UI element and it is not responsible for managing data state. It cooperates with
the `arc-models` elements and use HTML event system to exchange data.
See demo page for an example of use.

If `arc-models` can't be used then replacements must to support events fired by this element:
- variables-env-model-insert
- variables-env-model-query
- variables-env-model-delete
- variables-model-query
- variables-model-delete
- variables-model-insert

### Example
```
<variables-editor></variables-editor>
```

### Styling
`<variables-editor>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--variables-editor` | Mixin applied to the element | `{}`
`--variables-editor-variables-info-color` | Color of the info text below environment selector | `rgba(0, 0, 0, 0.54)`
`--variables-editor-variables-info-font-size` | Font size of the info text below environment selector | `14px`
`--variables-editor-add-color` | Color of the `add` buttons (icons) | `--primary-color`
`--variables-editor-remove-env-color` | Color of the remove button (icon) | `rgba(0, 0, 0, 0.24)`
`--variables-editor-remove-env-color-hover` | Color of the hovered remove button (icon) | `#e64a19`
`--accent-color` | Background color of the primary action button | ``
`--primary-light-color` | Color of the primary action button | `#fff`
`--variables-editor-docs-frame` | Mixin applied to the help section when there is no variables defined for the environment | `{}`
`--variables-editor-docs-frame-content` | Mixin applied to the colored content container of the help section. | `{}`
`--variables-editor-docs-frame-content-background` | Background color of the help section content container. | `#E1F5FE`
`--variables-editor-docs-frame-content-font-size` | Font size  of the help section content container. | `15px`

@group UI Elements
@element variables-editor
@demo demo/index.html
-->
<dom-module id="variables-editor">
  <template>
    <style include="shared-styles">
     :host {
      display: block;
      padding: 12px;
      @apply(--variables-editor);
    }

    .env-info {
      @apply(--layout-horizontal);
      @apply(--layout-center);
      @apply(--paper-font-body1);
      color: var(--variables-editor-variables-info-font-size, 14px);
      color: var(--variables-editor-variables-info-color, rgba(0, 0, 0, 0.54));
    }

    .env-info iron-icon {
      width: 16px;
      height: 16px;
      margin-right: 8px;
    }

    .add-button {
      color: var(--variables-editor-add-color, --primary-color);
    }

    .add-env {
      vertical-align: bottom;
    }

    .primary-button {
      background-color: var(--accent-color);
      color: var(--primary-light-color, #fff);
      @apply(--primary-button);
    }

    .remove-button {
      color: var(--variables-editor-remove-env-color, rgba(0, 0, 0, 0.24));
      transition: color 0.2s linear;
    }

    .remove-button:hover {
      color: var(--variables-editor-remove-env-color-hover, #e64a19);
    }

    .env-selector {
      @apply(--layout-horizontal);
      @apply(--layout-wrap);
    }

    .env-selector paper-icon-button {
      align-self: flex-end;
    }

    .app-link {
      text-decoration: none;
    }

    .help {
      @apply(--layout-horizontal);
      @apply(--layout-center);
      @apply(--variables-editor-docs-frame);
    }

    .doc-frame {
      padding: 24px;
      background-color: var(--variables-editor-docs-frame-content-background, #E1F5FE);
      font-size: var(--variables-editor-docs-frame-content-font-size, 15px);
      @apply(--variables-editor-docs-frame-content);
    }

    .flex {
      @apply(--layout-flex);
    }

    </style>
    <section>

      <div class="env-selector">
        <paper-dropdown-menu label="Environment">
          <paper-listbox class="dropdown-content" selected="{{currentEnvironment}}" attr-for-selected="data-environment">
            <paper-item data-environment="default">Default</paper-item>
            <template is="dom-repeat" items="[[environments]]">
              <paper-item data-environment="[[item.name]]">[[item.name]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
        <paper-icon-button on-tap="addEnvironment" class="add-button add-env" title="Add new environment" icon="arc:add-circle-outline"></paper-icon-button>
        <paper-icon-button hidden$="[[hideRemoved]]" on-tap="removeEnvironment" class="remove-button" title="Remove this environment" icon="arc:remove-circle-outline"></paper-icon-button>
        <div class="flex"></div>
        <div class="help" hidden$="[[noVariables]]">
          <p>Learn more about the variables and environments</p>
          <a href="https://restforchrome.blogspot.co.uk/2016/11/variables-and-environments-in-advanced.html" target="_blank" class="app-link">
            <paper-button raised class="primary-button">Learn more</paper-button>
          </a>
        </div>
      </div>

      <iron-collapse opened="[[envEditorOpened]]">
        <div class="add-editor">
          <paper-input id="editorEnvName" label="Environment name" error-message="Name is required" required auto-validate></paper-input>
          <paper-button on-tap="addEnvSave" class="primary-button">Save environment</paper-button>
          <paper-button on-tap="cancelAddEnvironment" class="">Cancel</paper-button>
        </div>
      </iron-collapse>

      <div class="env-info">
        <iron-icon icon="arc:info-outline"></iron-icon>
        <p>Selected environment will be applied to current request</p>
      </div>
    </section>
    <section>
      <template is="dom-repeat" items="[[variables]]" id="repeater">
        <variable-item item="[[item]]"></variable-item>
      </template>
      <template is="dom-if" if="[[noVariables]]" restamp="true">
        <div class="doc-frame">
          <p>Create variables and insert them into the request.</p>
          <p>Just put variable name in format <i>${variable name}</i> into any request field and the value will be inserted at run time.</p>
          <a href="https://restforchrome.blogspot.co.uk/2016/11/variables-and-environments-in-advanced.html" target="_blank" class="app-link">
            <paper-button raised class="primary-button">Learn more</paper-button>
          </a>
        </div>
      </template>
    </section>
    <section>
      <paper-button class="add-button add-var" on-tap="_addVariable">add variable</paper-button>
    </section>
    <paper-toast text="" id="infoToast"></paper-toast>
    <paper-toast text="Model not found. Please, report an issue." id="noModel"></paper-toast>
    <paper-toast text="" id="errorToast" duration="5000"></paper-toast>
  </template>
  <script>
  if (!Array.prototype.findIndex) {
    Object.defineProperty(Array.prototype, 'findIndex', {
      value: function(predicate) {
        'use strict';
        if (this === null) {
          throw new TypeError('Array.prototype.findIndex called on null or undefined');
        }
        if (typeof predicate !== 'function') {
          throw new TypeError('predicate must be a function');
        }
        var list = Object(this);
        var length = list.length >>> 0;
        var thisArg = arguments[1];
        var value;

        for (var i = 0; i < length; i++) {
          value = list[i];
          if (predicate.call(thisArg, value, i, list)) {
            return i;
          }
        }
        return -1;
      },
      enumerable: false,
      configurable: false,
      writable: false
    });
  }
  (function() {
    Polymer({
      is: 'variables-editor',

      properties: {
        currentEnvironment: {
          type: String,
          value: 'default',
        },

        variables: {
          type: Array,
          value: function() {
            return [];
          }
        },

        environments: {
          type: Array,
          value: function() {
            return [];
          }
        },

        noVariables: {
          type: Boolean,
          value: true,
          computed: '_computeNoVariables(variables.*)'
        },

        hideRemoved: {
          type: Boolean,
          value: true,
          computed: '_computeHideRemoved(currentEnvironment)'
        },

        envEditorOpened: {
          type: Boolean,
          value: false
        }
      },

      listeners: {
        'variable-deleted': '_onVariableDeleted',
        'variable-remove': '_removeVeriableFromUI'
      },

      observers: [
        '_envChanged(currentEnvironment)'
      ],

      attached: function() {
        this._refreshEnvironments();
      },

      _computeNoVariables: function() {
        if (!this.variables || !this.variables.length) {
          return true;
        }
        return false;
      },

      _computeHideRemoved: function(currentEnvironment) {
        if (!currentEnvironment || currentEnvironment === 'default') {
          return true;
        }
        return false;
      },
      // Add new, empty variable.
      _addVariable: function() {
        this.push('variables', {
          environment: this.currentEnvironment,
          enabled: false
        });
        this.fire('send-analytics', {
          type: 'event',
          category: 'Variables editor',
          action: 'Add variable'
        });
      },
      // Handler for en event sent by a child element to selete saved environment.
      _onVariableDeleted: function(e) {
        var id = e.detail.id;
        var index = this.variables.findIndex(function(i) { return i._id === id; });
        if (index !== -1) {
          this.splice('variables', index, 1);
        }
        this.fire('send-analytics', {
          type: 'event',
          category: 'Variables editor',
          action: 'Delete variable'
        });
      },
      // Opens environment editor.
      addEnvironment: function() {
        this.envEditorOpened = true;
      },

      cancelAddEnvironment: function() {
        this.envEditorOpened = false;
      },
      // Saves new environment.
      addEnvSave: function() {
        var name = this.$.editorEnvName.value;
        if (!name) {
          this.$.editorEnvName.validate();
          return;
        }
        var lowerName = name.toLowerCase();
        if (lowerName === 'default') {
          this.$.infoToast.text = 'This name is reserved';
          this.$.infoToast.opened = true;
          return;
        }
        var index = this.environments.findIndex(function(i) {
          return i.name.toLowerCase() === lowerName;
        });
        if (index !== -1) {
          this.$.infoToast.text = 'Environment already exists';
          this.$.infoToast.opened = true;
          return;
        }

        var obj = {
          name: name,
          created: Date.now()
        };
        var e = this.fire('variables-env-model-insert', {
          doc: obj
        });
        if (event.detail.error || !e.detail.result) {
          this.$.noModel.opened = true;
          return;
        }
        var context = this;
        e.detail.result.then(function(doc) {
          context.$.editor.opened = false;
          context.push('environments', doc);
          context.set('currentEnvironment', name);
          context.set('variables', []);
          context._addVariable();
        })
        .catch(function(e) {
          context.$.errorToast.text = 'Error save data: ' + e.message;
          context.$.errorToast.opened = true;
        });
        this.fire('send-analytics', {
          type: 'event',
          category: 'Variables editor',
          action: 'Add environment'
        });
      },
      // Requests the data store for list of environments.
      _refreshEnvironments: function() {
        var event = this.fire('variables-env-model-query', {});
        if (event.detail.error || !event.detail.result) {
          this.$.noModel.opened = true;
          return;
        }
        var context = this;
        event.detail.result.then(function(docs) {
          context.set('environments', docs);
        })
        .catch(function(e) {
          context.$.errorToast.text = 'Error save data: ' + e.message;
          context.$.errorToast.opened = true;
        });
      },
      // handler for env value change
      _envChanged: function(currentEnvironment) {
        this.set('variables', []);

        this.fire('variables-environment-changed', {
          env: currentEnvironment
        });

        this._queryEnvVariables();

        this.fire('send-analytics', {
          type: 'event',
          category: 'Variables editor',
          action: 'Select environment'
        });
      },
      // When env change this will query variables automatically
      _queryEnvVariables: function() {
        var event = this.fire('variables-model-query', {
          environment: this.currentEnvironment
        });
        if (event.detail.error || !event.detail.result) {
          this.$.noModel.opened = true;
          return;
        }
        var context = this;
        event.detail.result.then(function(docs) {
          context.set('variables', docs);
        })
        .catch(function(e) {
          context.$.errorToast.text = 'Error reading data: ' + e.message;
          context.$.errorToast.opened = true;
        });
      },
      // Removes the environment
      removeEnvironment: function() {
        if (this.currentEnvironment === 'default') {
          return;
        }
        var old = this.currentEnvironment;
        this.set('currentEnvironment', 'default');

        var index = this.environments.findIndex(function(i) { return i.name === old; });
        if (index === -1) {
          this.$.errorToast.text = 'Something is wrong. Can\'t find item.';
          this.$.errorToast.opened = true;
          return;
        }
        var item = this.environments[index];
        var event = this.fire('variables-env-model-delete', {
          doc: item
        });
        if (event.detail.error || !event.detail.result) {
          this.$.noModel.opened = true;
          return;
        }
        var context = this;
        event.result.then(function() {
          context.splice('environments', index, 1);
        })
        .catch(function(e) {
          context.$.errorToast.text = 'Error deleting data: ' + e.message;
          context.$.errorToast.opened = true;
        });
        this.fire('send-analytics', {
          type: 'event',
          category: 'Variables editor',
          action: 'Delete environment'
        });
      },
      // Removed unsaved variable
      _removeVeriableFromUI: function(e) {
        var index = this.$.repeater.indexForElement(e.target);
        if (index === -1) {
          return;
        }
        this.splice('variables', index, 1);
      }
    });
  })();
  </script>
</dom-module>
