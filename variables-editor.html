<!--
@license
Copyright 2018 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/utils/render-status.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../environment-selector/environment-selector.html">
<link rel="import" href="variable-item.html">
<dom-module id="variables-editor">
  <template>
    <style>
     :host {
      display: block;
      padding: 12px;
      @apply --variables-editor;
      --button-transition: color 0.2s linear;
    }

    .add-button {
      transition: var(--button-transition);
      color: var(--variables-editor-add-color, var(--primary-color));
    }

    .primary-button {
      background-color: var(--variables-editor-primary-button-background-color, var(--accent-color));
      color: var(--variables-editor-primary-button-color, var(--primary-light-color, #fff));
      @apply --primary-button;
    }

    .env-selector {
      @apply --layout-horizontal;
      @apply --layout-end;
      @apply --layout-wrap;
      margin-bottom: 20px;
    }

    .env-selector paper-button {
      height: 40px;
      margin-bottom: 8px;
    }

    .app-link {
      text-decoration: none;
      color: inherit;
    }

    .doc-frame {
      padding: 24px;
      background-color: var(--variables-editor-docs-frame-content-background, #E1F5FE);
      @apply --arc-font-body1;
      @apply --variables-editor-docs-frame-content;
    }

    .flex {
      @apply --layout-flex;
    }

    .add-editor {
      margin: 40px 0;
      background-color: var(--variables-editor-add-environment-content-background-color, #f5f5f5);
      padding-left: 12px;
      padding-right: 12px;
      padding-bottom: 20px;
      @apply --variables-editor-add-environment-content;
    }

    #editorEnvName {
      margin-bottom: 20px;
    }

    .tutorial-title {
      margin-top: 0;
      @apply --arc-font-title;
    }

    .tutorial-title-label {
      vertical-align: middle;
      margin-left: 8px;
    }

    .tutorial-link {
      margin-top: 12px;
      margin-bottom: 0;
    }

    .text-link {
      color: rgba(0, 0, 0, 0.74);
    }

    .tutorial-link iron-icon {
      width: 16px;
      height: 16px;
      color: rgba(0, 0, 0, 0.74);
    }
    </style>
    <section>
      <div class="env-selector">
        <environment-selector id="envSelector" selected="{{environment}}"></environment-selector>
        <paper-button on-click="addEnvironment" class="add-env" title="Add new environment">Add</paper-button>
        <template is="dom-if" if="[[allowRemove]]">
          <paper-button on-click="_deleteEnvironment" class="remove-env" title="Remove environment and variables">Remove</paper-button>
        </template>
        <div class="flex"></div>
        <a href="https://restforchrome.blogspot.co.uk/2016/11/variables-and-environments-in-advanced.html" target="_blank" class="app-link" on-click="_openHelp">
          <paper-button class="info-button">Help</paper-button>
        </a>
      </div>
      <iron-collapse opened="[[envEditorOpened]]">
        <div class="add-editor">
          <paper-input id="editorEnvName" label="Environment name" error-message="Name is required" required auto-validate></paper-input>
          <paper-button on-click="_addEnvironment" class="primary-button">Save environment</paper-button>
          <paper-button on-click="_cancelAddEnvironment" class="">Cancel</paper-button>
        </div>
      </iron-collapse>
    </section>
    <section hidden$="[[envEditorOpened]]">
      <template is="dom-repeat" items="[[variables]]" id="repeater">
        <variable-item item="[[item]]" on-empty-variable-remove="_removeEmptyVariable"></variable-item>
      </template>
      <template is="dom-if" if="[[!hasVariables]]">
        <div class="doc-frame">
          <h4 class="tutorial-title"><iron-icon icon="arc:code"></iron-icon><span class="tutorial-title-label">Upgrade request with variables</span></h4>
          <p>Put <code>${variableName}</code> into any request field and the value will be inserted at run time.</p>
          <paper-button raised class="primary-button" on-click="_addVariable">add variable</paper-button>
          <p class="tutorial-link">
            <a href="https://restforchrome.blogspot.co.uk/2016/11/variables-and-environments-in-advanced.html" target="_blank" class="text-link" on-click="_openHelp">Learn more about variables.</a>
            <iron-icon icon="arc:open-in-new"></iron-icon>
          </p>
        </div>
      </template>
    </section>
    <section hidden$="[[_computeAddButtonHidden(envEditorOpened, hasVariables)]]">
      <paper-button class="add-button add-var" on-click="_addVariable">add variable</paper-button>
    </section>
    <paper-toast text="" id="infoToast"></paper-toast>
  </template>
  <script>
  /**
   * A variables editor is an element to render UI for `variables-manager`.
   *
   * It displays list of user defined environments and variables associated with
   * the  environment.
   *
   * This element requires compatible variables manager to be present in the DOM. It
   * uses browser event system to communicate with the manager. See `variables-manager`
   * documentation for detailed API for data exchange.
   *
   * ### Example
   *
   * ```html
   * <variables-editor></variables-editor>
   * <variables-manager></variables-manager>
   * ```
   *
   * ### Styling
   *
   * `<variables-editor>` provides the following custom properties and mixins
   * for styling:
   *
   * Custom property | Description | Default
   * ----------------|-------------|----------
   * `--variables-editor` | Mixin applied to the element | `{}`
   * `--variables-editor-add-color` | Color of the `add` button | `--primary-color`
   * `--variables-editor-add-environment-color` | Color of the add environment
   * icon button | `rgba(0, 0, 0, 0.54)`
   * `--variables-editor-add-environment-color-hover | Color of the add environment
   * icon button when hovering | `--accent-color` or `rgba(0, 0, 0, 0.74)`
   * `--variables-editor-remove-env-color` | Color of the remove button (icon)
   * | `rgba(0, 0, 0, 0.24)`
   * `--variables-editor-remove-env-color-hover` | Color of the hovered remove
   * button (icon) | `#e64a19`
   * `--accent-color` | Background color of the primary action button | ``
   * `--primary-light-color` | Color of the primary action button | `#fff`
   * `--variables-editor-docs-frame-content` | Mixin applied to the colored
   * content container of the help section. | `{}`
   * `--variables-editor-docs-frame-content-background` | Background color of the
   * help section content container. | `#E1F5FE`
   * `--arc-font-title` | Theme mixin, applied to the tutorial title | `{}`
   * `--arc-font-body1` | Theme mixin, applied to text labels | `{}`
   * `--variables-editor-primary-button-background-color` | Background color of
   * the primary action button | `--accent-color`
   * `--variables-editor-primary-button-color` | Color of the primary action
   * button | `--primary-light-color` or `#fff`
   * `--primary-button` | Mixin applied to the primary button | `{}`
   * `--variable-item` | Mixin applied to the variable item container | `{}`
   * `--variable-item-name-input` | Mixin applied to the `paper-input` for
   * variable name | `{}`
   * `--variable-item-value-input` | Mixin applied to the `paper-input` for
   * variable value | `{}`
   * `--variable-item-checkbox` | Mixin applied to the state checkbox | `{}`
   * `--inline-fom-action-icon-color` | Theme variable, color of the delete
   * variable icon | `rgba(0, 0, 0, 0.74)`
   * `--inline-fom-action-icon-color-hover` | Theme variable, color of the
   * delete variable icon when hovering | `--accent-color` or `rgba(0, 0, 0, 0.74)`
   *
   * @memberof UiElements
   * @customElement
   * @polymer
   * @demo demo/index.html
   */
  class VariablesEditor extends Polymer.Element {
    static get is() { return 'variables-editor'; }
    static get properties() {
      return {
        /**
         * Currently selected environment.
         */
        environment: String,
        /**
         * List of available variables for the environment.
         */
        variables: Array,
        /**
         * Computed value, true is variables are available for current
         * environment.
         */
        hasVariables: {
          type: Boolean,
          value: false,
          computed: '_computeHasVariables(variables.*)'
        },
        /**
         * Computed value, set to `true` if the environment can be removed.
         * Only `default` environment can't be deleted
         */
        allowRemove: {
          type: Boolean,
          computed: '_computeAllowRemove(environment)'
        },
        // True if the environment editor is opened.
        envEditorOpened: {
          type: Boolean,
          value: false
        }
      };
    }

    constructor() {
      super();
      this._envUpdatedHandler = this._envUpdatedHandler.bind(this);
      this._varDeletedHandler = this._varDeletedHandler.bind(this);
      this._varUpdateHandler = this._varUpdateHandler.bind(this);
      this._varListChangedHandler = this._varListChangedHandler.bind(this);
    }

    connectedCallback() {
      super.connectedCallback();
      window.addEventListener('environment-updated', this._envUpdatedHandler);
      window.addEventListener('variable-deleted', this._varDeletedHandler);
      window.addEventListener('variable-updated', this._varUpdateHandler);
      window.addEventListener('variables-list-changed', this._varListChangedHandler);
      Polymer.RenderStatus.afterNextRender(this, () => this.refresh());
    }

    disconnectedCallback() {
      super.disconnectedCallback();
      window.removeEventListener('environment-updated', this._envUpdatedHandler);
      window.removeEventListener('variable-deleted', this._varDeletedHandler);
      window.removeEventListener('variable-updated', this._varUpdateHandler);
      window.removeEventListener('variables-list-changed', this._varListChangedHandler);
    }

    /**
     * Refreshes the list of variables and environment on demand.
     */
    refresh() {
      this._refreshVariables();
      this._refreshEnvironment();
    }
    /**
    * Dispatches `variable-list` custom event to ask variables manager
    * for list of variables.
     */
    _refreshVariables() {
      const e = new CustomEvent('variable-list', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {}
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        return;
      }
      const variables = e.detail.value;
      if (!variables) {
        return;
      }
      this.set('variables', this._processVariables(variables));
    }
    /**
     * Dispatches `environment-current` custom event to ask variables manager
     * for current environment.
     */
    _refreshEnvironment() {
      const e = new CustomEvent('environment-current', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {}
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        return;
      }
      this.set('environment', e.detail.value);
    }
    /**
     * Processes variables list returned by the variables manager.
     * Filters out variables that are set in platform environment.
     *
     * @param {Array} variables List of variables received from the manager.
     * @return {Array} Updated list of variables.
     */
    _processVariables(variables) {
      if (!variables) {
        return variables;
      }
      variables = variables.filter((item) => !item.sysVar);
      return variables;
    }

    // Computes `hasVariables` property.
    _computeHasVariables(record) {
      return !!(record && record.base && record.base.length);
    }
    // computes `allowRemove` property.
    _computeAllowRemove(environment) {
      return !!(environment && environment !== 'default');
    }

    // Handler for the `environment-updated` event.
    _envUpdatedHandler(e) {
      if (e.cancelable) {
        return;
      }
      const env = e.detail.value;
      this._checkUpdateEnvironment(env);
    }

    _checkUpdateEnvironment(updated) {
      if (!this.__lastCreatedEnvironment) {
        return;
      }
      if (updated && updated.name === this.__lastCreatedEnvironment) {
        this.__lastCreatedEnvironment = undefined;
        this.set('environment', updated.name);
      }
    }
    // Handler for the `variable-deleted` event.
    _varDeletedHandler(e) {
      if (e.cancelable || !this.variables) {
        return;
      }
      const id = e.detail.value;
      const index = this.variables.findIndex((item) => item._id === id);
      if (index === -1) {
        return;
      }
      this.splice('variables', index, 1);
      this.$.repeater.render();
    }
    // Handler for the `variable-updated` event.
    _varUpdateHandler(e) {
      if (e.cancelable) {
        return;
      }
      if (!this.variables) {
        return;
      }
      const env = e.detail.value;
      if (env.sysVar) {
        return;
      }
      if (!this.variables) {
        this.set('variables', [env]);
        this.$.repeater.render();
        return;
      }
      let index = this.variables.findIndex((item) => item._id === env._id);
      if (index === -1) {
        // Here's a trick. When adding new variable it is not saved yet
        // and we should check for a var with the same name.
        index = this.variables.findIndex((item) =>
          (!item._id && item.variable === env.variable));
        if (index === -1) {
          this.push('variables', env);
        }
      }
      if (~index) {
        this.set(['variables', index], env);
      }
      this.$.repeater.render();
    }
    // Handler for the `variables-list-changed` event.
    _varListChangedHandler(e) {
      if (e.cancelable) {
        return;
      }
      const eventVars = e.detail.value;
      let vars;
      if (eventVars && eventVars.length) {
        vars = eventVars.map((item) => Object.assign({}, item));
      }
      this.set('variables', this._processVariables(vars));
      this.$.repeater.render();
    }
    // Opens environment editor.
    addEnvironment() {
      this.envEditorOpened = true;
    }

    _cancelAddEnvironment() {
      this.envEditorOpened = false;
    }
    // Handler for the save action for add environment form.
    _addEnvironment() {
      const name = this.$.editorEnvName.value;
      if (!name) {
        this.$.editorEnvName.validate();
        return;
      }
      const lowerName = name.toLowerCase();
      if (lowerName === 'default') {
        this._toast('This name is reserved. Please, use different name');
        this._sendGaEvent('Addind reserved name environment');
        return;
      }
      const envs = this.$.envSelector.environments || [];
      const index = envs.findIndex((i) => i.name.toLowerCase() === lowerName);
      if (!!~index) {
        this._toast('Environment already exists. Please, use different name');
        this._sendGaEvent('Addind existing environment');
        return;
      }
      const obj = {
        name: name,
        created: Date.now()
      };
      const e = new CustomEvent('environment-updated', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {
          value: obj
        }
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        this._toast('Variables manager not found. Please, report an issue.');
        this._sendGaError('Add environment - no manager');
        throw new Error('Variables manager not found.');
      }
      e.detail.result
      .catch((cause) => {
        this._toast(cause.message);
        this._sendGaError('Add environment-' + cause.message);
      });

      this._cancelAddEnvironment();
      this.__lastCreatedEnvironment = name;
      this._sendGaEvent('Add environment');
    }
    // Show toast with the message
    _toast(message) {
      this.$.infoToast.text = message;
      this.$.infoToast.opened = true;
    }
    // Handler for the delete button.
    _deleteEnvironment() {
      if (this.environment === 'default') {
        return;
      }
      const envs = this.$.envSelector.environments || [];
      if (!envs) {
        this._toast('The list of environments is empty.');
        return;
      }
      const old = this.environment;
      const oldLowerCase = old.toLowerCase();
      const item = envs.find((i) => i.name.toLowerCase() === oldLowerCase);
      if (!item) {
        this._toast(`The environment ${old} is not in the list.`);
        this._sendGaError('Envitonment not in the list when deleting');
        return;
      }
      const e = new CustomEvent('environment-deleted', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {
          value: item._id
        }
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        this._toast('Variables manager not found. Please, report an issue.');
        this._sendGaError('Remove environment - no manager');
        throw new Error('Variables manager not found.');
      }
      e.detail.result
      .catch((cause) => {
        this._toast(cause.message);
        this._sendGaError('Remove environment-' + cause.message);
      });
      this.set('environment', 'default');
      this._sendGaEvent('Delete environment');
    }
    // Add new, empty variable.
    _addVariable() {
      const obj = {
        environment: this.environment,
        enabled: false
      };
      if (!this.variables) {
        this.set('variables', [obj]);
      } else {
        this.push('variables', obj);
      }
      this._sendGaEvent('Add variable');
    }
    /**
     * Sends usage google analytics event
     * @param {String} action Action description
     */
    _sendGaEvent(action) {
      this.dispatchEvent(new CustomEvent('send-analytics', {
        bubbles: true,
        composed: true,
        detail: {
          type: 'event',
          category: 'Variables editor',
          action
        }
      }));
    }
    /**
     * Sends error event to google analytics
     * @param {String} message Exception message
     */
    _sendGaError(message) {
      this.dispatchEvent(new CustomEvent('send-analytics', {
        bubbles: true,
        composed: true,
        detail: {
          type: 'exception',
          description: message,
          fatal: false
        }
      }));
    }
    /**
     * Removes unsaved variable
     * @param {CustomEvent} e
     */
    _removeEmptyVariable(e) {
      const index = e.model.get('index');
      if (index === -1) {
        return;
      }
      this.splice('variables', index, 1);
    }

    _computeAddButtonHidden(envEditorOpened, hasVariables) {
      return envEditorOpened || !hasVariables;
    }

    /**
     * Opens documentation page for the module.
     */
    _openHelp(e) {
      let url = e.currentTarget.href;
      const ev = new CustomEvent('open-external-url', {
        bubbles: true,
        cancelable: true,
        detail: {
          url: url
        }
      });
      this.dispatchEvent(ev);
      if (ev.defaultPrevented) {
        return;
      }
      e.preventDefault();
      e.stopPropagation();
      window.open(url);
    }

    /**
     * When an external URL is requested to open.
     * @event open-external-url
     * @param {url}
     */
  }
  window.customElements.define(VariablesEditor.is, VariablesEditor);
  </script>
</dom-module>
