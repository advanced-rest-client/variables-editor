<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../@polymer/test-fixture/test-fixture.js"></script>
    <script src="../../../mocha/mocha.js"></script>
    <script src="../../../chai/chai.js"></script>
    <script src="../../../wct-mocha/wct-mocha.js"></script>

  </head>
  <body>

    <test-fixture id="Basic">
      <template>
        <variable-editor-dialog></variable-editor-dialog>
      </template>
    </test-fixture>

    <script type="module">
    import '../variable-editor-dialog.js';
    suite('Initialization', () => {
      let element;
      setup((done) => {
        element = fixture('Basic');
        flush(() => done());
      });

      test('Docs is set', () => {
        assert.typeOf(element.docs, 'array');
        assert.lengthOf(element.docs, 17);
      });
    });

    suite('_selectedDocChanged()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
      });

      test('Sets list to String functions', () => {
        element._selectedDocChanged(0);
        assert.typeOf(element.docs, 'array');
        assert.lengthOf(element.docs, 17);
      });

      test('Sets list to Math functions', () => {
        element._selectedDocChanged(1);
        assert.typeOf(element.docs, 'array');
        assert.lengthOf(element.docs, 35);
      });

      test('Sets list to other functions', () => {
        element._selectedDocChanged(2);
        assert.typeOf(element.docs, 'array');
        assert.lengthOf(element.docs, 4);
      });

      test('Clears list otherwise', () => {
        element._selectedDocChanged(3);
        assert.isUndefined(element.docs);
      });
    });

    suite('_insertFunction()', () => {
      let element;
      setup((done) => {
        element = fixture('Basic');
        flush(() => done());
      });

      test('Inserts function with no arguments', () => {
        const model = {
          name: 'Test',
          args: 0
        };
        element._insertFunction(model);
        assert.equal(element.value, 'Test()');
      });

      test('Inserts function with 1 argument', () => {
        const model = {
          name: 'Test',
          args: 1
        };
        element._insertFunction(model);
        assert.equal(element.value, 'Test(a)');
      });

      test('Inserts function with 2 argument', () => {
        const model = {
          name: 'Test',
          args: 2
        };
        element._insertFunction(model);
        assert.equal(element.value, 'Test(a, b)');
      });

      test('Inserts function with 3 argument', () => {
        const model = {
          name: 'Test',
          args: 3
        };
        element._insertFunction(model);
        assert.equal(element.value, 'Test(a, b, c)');
      });

      test('Inserts math argument', () => {
        element.selectedDoc = 1;
        const model = {
          name: 'Test',
          args: 3
        };
        element._insertFunction(model);
        assert.equal(element.value, 'Test(x, y, z)');
      });

      test('Concatenates existing value', () => {
        const model = {
          name: 'Test',
          args: 0
        };
        element.value = 'test-value';
        element._insertFunction(model);
        assert.equal(element.value, 'test-value Test()');
      });
    });

    suite('_evaluate()', () => {
      let element;
      setup((done) => {
        element = fixture('Basic');
        flush(() => done());
      });

      const evaluatedValue = 'evaluated-value';
      function evalHandler(e) {
        e.preventDefault();
        e.detail.result = Promise.resolve(evaluatedValue);
      }

      suiteSetup(() => {
        window.addEventListener('evaluate-variable', evalHandler);
      });

      suiteTeardown(() => {
        window.removeEventListener('evaluate-variable', evalHandler);
      });

      test('Does nothing when no value', () => {
        const spy = sinon.spy();
        element.addEventListener('evaluate-variable', spy);
        element._evaluate();
        assert.isFalse(spy.called);
      });

      test('Sets "evaluated" property', (done) => {
        element.value = 'test';
        element._evaluate();
        setTimeout(() => {
          assert.equal(element.evaluated, evaluatedValue);
          done();
        });
      });

      test('Opens toast when event is not handled', () => {
        element.addEventListener('evaluate-variable', function f(e) {
          element.removeEventListener('evaluate-variable', f);
          e.stopPropagation();
        });
        element.value = 'test';
        element._evaluate();
        assert.isTrue(element.$.errorToast.opened);
      });

      test('Opens toast when error', (done) => {
        element.addEventListener('evaluate-variable', function f(e) {
          element.removeEventListener('evaluate-variable', f);
          e.stopPropagation();
          e.preventDefault();
          e.detail.result = Promise.reject(new Error('test'));
        });
        element.value = 'test';
        element._evaluate();
        setTimeout(() => {
          assert.isTrue(element.$.errorToast.opened);
          done();
        });
      });
    });

    suite('_onClosed()', () => {
      let element;
      let ev;
      setup(() => {
        element = fixture('Basic');
        ev = {
          stopPropagation: () => {},
          detail: {
            confirmed: true
          }
        };
      });

      test('Does nothing when dialog is canceled', () => {
        ev.detail.canceled = true;
        const spy = sinon.spy();
        element.addEventListener('variable-editor-closed', spy);
        element._onClosed(ev);
        assert.isFalse(spy.called);
      });

      test('Does nothing when dialog is not confirmed', () => {
        ev.detail.confirmed = false;
        const spy = sinon.spy();
        element.addEventListener('variable-editor-closed', spy);
        element._onClosed(ev);
        assert.isFalse(spy.called);
      });

      test('Dispatches close event', () => {
        const spy = sinon.spy();
        element.addEventListener('variable-editor-closed', spy);
        element._onClosed(ev);
        assert.isTrue(spy.called);
      });

      test('Event has new value', () => {
        const spy = sinon.spy();
        element.addEventListener('variable-editor-closed', spy);
        element.value = 'test';
        element._onClosed(ev);
        assert.equal(spy.args[0][0].detail.value, 'test');
      });
    });

    suite('_processFunctionInsertClick()', () => {
      let element;
      setup((done) => {
        element = fixture('Basic');
        flush(() => done());
      });

      test('Does nothing when clicked on list item', () => {
        const node = element.shadowRoot.querySelector('div.di');
        const spy = sinon.spy(element, '_insertFunction');
        node.click();
        assert.isFalse(spy.called);
      });

      test('Does nothing when target instance not found', () => {
        const node = document.createElement('paper-button');
        const spy = sinon.spy(element, '_insertFunction');
        element._processFunctionInsertClick({
          target: node
        });
        assert.isFalse(spy.called);
      });

      test('Calls _insertFunction', () => {
        const node = element.shadowRoot.querySelector('div.di paper-button');
        const spy = sinon.spy(element, '_insertFunction');
        node.click();
        assert.isTrue(spy.called);
      });

      test('Function alls has item model', () => {
        const node = element.shadowRoot.querySelector('div.di paper-button');
        const spy = sinon.spy(element, '_insertFunction');
        node.click();
        assert.typeOf(spy.args[0][0], 'object');
      });
    });
    </script>

  </body>
</html>
